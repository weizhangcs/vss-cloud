# docker-compose.prod.yml

services:
  db:
    image: postgres:16-alpine
    restart: always
    volumes:
      - ./prod_data/postgres:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    restart: always
    volumes:
      - ./prod_data/redis:/data

  web:
    image: ghcr.io/weizhangcs/vss-cloud:latest
    command: gunicorn core.wsgi:application --bind 0.0.0.0:8000
    expose:
      - 8000
    volumes:
      - ./staticfiles:/app/staticfiles
      - ./shared_media:/app/shared_media
    depends_on:
      - db
      - redis
    env_file:
      - .env

  # --- Worker 生产配置 (流控策略) ---

  worker_gemini:
    image: ghcr.io/weizhangcs/vss-cloud:latest
    restart: always
    # [流控] 限制并发为 2，严格保护 Google API 配额
    command: celery -A core worker -Q queue_gemini -c 2 -l info
    volumes:
      - ./shared_media:/app/shared_media

  worker_audio:
    image: ghcr.io/weizhangcs/vss-cloud:latest
    restart: always
    # [流控] 限制并发为 4，平衡 CPU 负载
    command: celery -A core worker -Q queue_audio -c 4 -l info
    volumes:
      - ./shared_media:/app/shared_media

  worker_io:
    image: ghcr.io/weizhangcs/vss-cloud:latest
    restart: always
    # [流控] 并发 8，最大化 IO 吞吐
    command: celery -A core worker -Q queue_io,celery -c 8 -l info
    volumes:
      - ./shared_media:/app/shared_media

  nginx:
    image: nginx:1.25-alpine
    ports:
      - "80:80"
    volumes:
      - ./conf/nginx.template.conf:/etc/nginx/conf.d/default.conf.template
      - ./staticfiles:/app/staticfiles:ro
    depends_on:
      - web
    environment:
      - SERVER_DOMAIN
    entrypoint: /bin/sh -c "envsubst '$$SERVER_DOMAIN' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"