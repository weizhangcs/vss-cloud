# docker-compose.base.yml
# -----------------------------------------------------------------------------
# 描述: VSS Cloud 基础架构配置
# 作用: 定义所有环境共用的服务拓扑、逻辑挂载点和环境变量。
# 策略: 子环境文件 (dev/test/prod) 仅需覆盖差异项，无需重复定义。
# -----------------------------------------------------------------------------

services:
  # --- 基础组件 (Infrastructure) ---
  db:
    image: postgres:16-alpine
    volumes:
      # [核心] 逻辑挂载：所有环境统一指向容器内标准数据目录
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 5s
      timeout: 5s
      retries: 10
    environment:
      - TZ=Asia/Shanghai
    env_file:
      - .env

  redis:
    image: redis:7-alpine
    volumes:
      # [核心] 逻辑挂载：所有环境统一指向容器内标准数据目录
      - redis_data:/data
    environment:
      - TZ=Asia/Shanghai

  # --- 应用骨架 (Application Skeleton) ---
  web:
    # 依赖关系定义
    depends_on:
      - db
      - redis
    # 共享配置：环境变量与 GCP 凭证
    env_file:
      - .env
    environment:
      - TZ=Asia/Shanghai
      - GOOGLE_APPLICATION_CREDENTIALS=/app/conf/gcp-credentials.json
    volumes:
      - ./conf/gcp-credentials.json:/app/conf/gcp-credentials.json:ro

  # --- 异步任务集群 (Worker Cluster) ---
  # 说明: 拆分为三组以实现不同维度的流控与隔离

  # 1. Gemini 专用 (配额敏感/低并发)
  worker_gemini:
    command: celery -A core.celery worker -Q queue_gemini -l info
    depends_on:
      - db
      - redis
    env_file:
      - .env
    environment:
      - TZ=Asia/Shanghai
      - GOOGLE_APPLICATION_CREDENTIALS=/app/conf/gcp-credentials.json
      - C_FORCE_ROOT=true # 允许 Root 运行 (兼容 Windows/Docker 挂载权限)
    volumes:
      - ./conf/gcp-credentials.json:/app/conf/gcp-credentials.json:ro

  # 2. 音频处理 (计算密集/中并发)
  worker_audio:
    command: celery -A core.celery worker -Q queue_audio -l info
    depends_on:
      - db
      - redis
    env_file:
      - .env
    environment:
      - TZ=Asia/Shanghai
      - GOOGLE_APPLICATION_CREDENTIALS=/app/conf/gcp-credentials.json
      - C_FORCE_ROOT=true
    volumes:
      - ./conf/gcp-credentials.json:/app/conf/gcp-credentials.json:ro

  # 3. 通用/IO (高并发/兜底)
  worker_io:
    command: celery -A core.celery worker -Q queue_io,celery -l info
    depends_on:
      - db
      - redis
    env_file:
      - .env
    environment:
      - TZ=Asia/Shanghai
      - GOOGLE_APPLICATION_CREDENTIALS=/app/conf/gcp-credentials.json
      - C_FORCE_ROOT=true
    volumes:
      - ./conf/gcp-credentials.json:/app/conf/gcp-credentials.json:ro

# 定义顶层卷名 (具体物理路径由子文件决定)
volumes:
  postgres_data:
  redis_data: