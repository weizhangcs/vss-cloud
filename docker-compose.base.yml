# docker-compose.base.yml
# 注意：version 字段已废弃（Docker Compose v1.27+）
# version: '1.2.0'

services:
  # --- 基础服务 (所有环境通用) ---
  db:
    image: postgres:16-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      - TZ=Asia/Shanghai
      # 数据库凭证从 .env 读取，不在 YAML 中硬编码
    env_file:
      - .env

  redis:
    image: redis:7-alpine
    environment:
      - TZ=Asia/Shanghai

  # --- 应用服务骨架 (具体实现由 Override 决定) ---
  web:
    # image 或 build 在具体环境中定义
    # command 在具体环境中定义
    depends_on:
      - db
      - redis
    env_file:
      - .env
    environment:
      - TZ=Asia/Shanghai
      - GOOGLE_APPLICATION_CREDENTIALS=/app/conf/gcp-credentials.json
    volumes:
      # 凭证文件是所有环境都需要的
      - ./conf/gcp-credentials.json:/app/conf/gcp-credentials.json:ro

  worker:
    # image 或 build 在具体环境中定义
    command: celery -A core.celery worker -l info
    depends_on:
      - db
      - redis
    env_file:
      - .env
    environment:
      - TZ=Asia/Shanghai
      - GOOGLE_APPLICATION_CREDENTIALS=/app/conf/gcp-credentials.json
    volumes:
      - ./conf/gcp-credentials.json:/app/conf/gcp-credentials.json:ro

volumes:
  postgres_data: